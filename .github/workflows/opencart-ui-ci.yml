name: OpenCart UI Automation CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  ui-tests:
    name: UI Tests (${{ matrix.browser }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        browser: [ chrome, firefox, edge ]

    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # Java Setup
      # --------------------------------------------------
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # --------------------------------------------------
      # Maven Cache
      # --------------------------------------------------
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}

      # --------------------------------------------------
      # Start Selenium Grid (Browser-aware)
      # --------------------------------------------------
      - name: Start Selenium Grid
        run: |
          export BROWSER=${{ matrix.browser }}
          docker compose -f docker-compose.yml up -d

      # --------------------------------------------------
      # Wait for Grid to be Ready
      # --------------------------------------------------
      - name: Wait for Selenium Grid
        run: |
          echo "Waiting for Selenium Grid..."
          for i in {1..15}; do
            if curl -s http://localhost:4444/status | grep -q '"ready":true'; then
              echo "Selenium Grid is ready"
              break
            fi
            sleep 5
          done

      # --------------------------------------------------
      # Allure Metadata (browser-wise)
      # --------------------------------------------------
      - name: Add Allure Environment Info
        run: |
          mkdir -p allure-results
          echo "Browser=${{ matrix.browser }}" >> allure-results/environment.properties
          echo "OS=Ubuntu" >> allure-results/environment.properties
          echo "Java=21" >> allure-results/environment.properties
          echo "Framework=Selenium + TestNG" >> allure-results/environment.properties

      # --------------------------------------------------
      # Run UI Tests
      # --------------------------------------------------
      - name: Run UI Tests
        run: |
          mvn clean test \
          -DsuiteXmlFile=CrossBrowserTesting.xml \
          -Dbrowser=${{ matrix.browser }}

      # --------------------------------------------------
      # Stop Selenium Grid
      # --------------------------------------------------
      - name: Stop Selenium Grid
        if: always()
        run: docker compose down

      # --------------------------------------------------
      # Install Allure CLI (Reliable way)
      # --------------------------------------------------
      - name: Install Allure
        if: always()
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip
          curl -Ls https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.zip -o allure.zip
          unzip allure.zip
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure
          allure --version

      # --------------------------------------------------
      # Generate Browser-wise Allure Report
      # --------------------------------------------------
      - name: Generate Allure Report
        if: always()
        run: |
          allure generate allure-results \
          --clean \
          -o allure-report-${{ matrix.browser }}

      # --------------------------------------------------
      # Upload Allure HTML Report
      # --------------------------------------------------
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.browser }}
          path: allure-report-${{ matrix.browser }}

      # --------------------------------------------------
      # Upload Raw Artifacts
      # --------------------------------------------------
      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-artifacts-${{ matrix.browser }}
          path: |
            allure-results
            target/surefire-reports
            screenshots
